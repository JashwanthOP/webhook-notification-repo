name: Webhook Notification Workflow

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  pull_request:
    branches:
      - main  # Trigger on PR to main branch

jobs:
  send-webhook:
    runs-on: ubuntu-latest  # Use an Ubuntu runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up date and commit details
        id: set_details
        run: |
          export RECENT_COMMIT_HASH="$(git show --format="%H" -s)"
          export RECENT_COMMIT_DATE="$(git show --format="%cD" -s)"
          export RECENT_COMMIT_TITLE="$(git show --format="%s" -s)"
          export RECENT_COMMIT_AUTHOR_NAME="$(git show --format="%an" -s)"
          export RECENT_COMMIT_AUTHOR_EMAIL="$(git show --format="%ae" -s)"
          export WORKFLOW_RUN_ID="${{ github.run_id }}"
          export WORKFLOW_NAME="${{ github.workflow }}"
          echo "recent_commit_hash=$RECENT_COMMIT_HASH" >> $GITHUB_ENV
          echo "recent_commit_date=$RECENT_COMMIT_DATE" >> $GITHUB_ENV
          echo "recent_commit_title=$RECENT_COMMIT_TITLE" >> $GITHUB_ENV
          echo "recent_commit_author_name=$RECENT_COMMIT_AUTHOR_NAME" >> $GITHUB_ENV
          echo "recent_commit_author_email=$RECENT_COMMIT_AUTHOR_EMAIL" >> $GITHUB_ENV
          echo "workflow_run_id=$WORKFLOW_RUN_ID" >> $GITHUB_ENV
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_ENV

      - name: Create HTML Report (local)
        id: create_html_report
        run: |
          HTML_CONTENT=$(cat <<EOF
<!DOCTYPE html>
<html lang="en">
<body>
  <div>
    <h4>Workflow Details</h4>
    <table cellspacing="3" bgcolor="#000000">
      <tr bgcolor="#ffffff">
        <th>Workflow Run Id</th>
        <th>Workflow Name</th>
        <th>Image Name</th>
      </tr>
      <tr bgcolor="#ffffff">
        <td><a href="https://github.com/${{ github.repository }}/runs/#${{ env.workflow_run_id }}">${{ env.workflow_run_id }}</a></td>
        <td>${{ env.workflow_name }}</td>
        <td>${{ env.recent_commit_hash }}</td>
      </tr>
    </table>
  </div>
  
  <div>
    <h4>Recent Commit Details</h4>
    <table cellspacing="3" bgcolor="#000000">
      <tr bgcolor="#ffffff">
        <th>Commit Hash</th>
        <th>Commit Date</th>
        <th>Commit Title</th>
        <th>Commit Author Name</th>
        <th>Commit Author Email</th>
      </tr>
      <tr bgcolor="#ffffff">
        <td><a href="https://github.com/${{ github.repository }}/commit/${{ env.recent_commit_hash }}">${{ env.recent_commit_hash }}</a></td>
        <td>${{ env.recent_commit_date }}</td>
        <td>${{ env.recent_commit_title }}</td>
        <td>${{ env.recent_commit_author_name }}</td>
        <td>${{ env.recent_commit_author_email }}</td>
      </tr>
    </table>
  </div>
</body>
</html>
EOF
          echo "html_report=$HTML_CONTENT" >> $GITHUB_ENV

      - name: Send Webhook Notification with HTML Report to Slack
        if: always()  # Send webhook even if the job fails
        uses: slackapi/slack-github-action@v2.0.0
        with:
          payload-file-path: ".github/EmailTemplates/github-workflow-details.html"
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
